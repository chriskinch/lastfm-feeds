/*!
 * last.fm.feeds v0.1.0 - Last FM Feed JS
 * https://github.com/chriskinch/lastfm_widget
 */
!function(a){a.myLastFM=function(b,c,d,e,f){var g={limit:"10",size:64,period:"1month",cover:!0,album:!0,artist:!0,plays:!0,date:!0,recent:!0,playing:!0},h={},i=this,j=a(b);i.init=function(){switch(j.trigger("init"),i.settings=a.extend({},g,f),i.config=h,i.config.image_key=k(i.settings.size),i.config.gettopalbums={url:"http://ws.audioscrobbler.com/2.0/?method=user.gettopalbums&format=json&callback=?",params:{user:c,api_key:d,limit:i.settings.limit,size:i.settings.size,period:i.settings.period}},i.config.getrecenttracks={url:"http://ws.audioscrobbler.com/2.0/?method=user.getrecenttracks&format=json&callback=?",params:{user:c,api_key:d,limit:i.settings.limit}},e){case"gettopalbums":j.trigger("getjson"),i.getJSON(e,i.getTopAlbums);break;case"getrecenttracks":j.trigger("getjson"),i.getJSON(e,i.getRecentTracks);break;case"getnowplaying":j.trigger("getjson"),i.config.getrecenttracks.params.limit=1,i.getJSON("getrecenttracks",i.getNowPlaying);break;default:console.log("No feed specified.")}},i.getJSON=function(b,c){console.log(i.config[b].url),a.getJSON(i.config[b].url,i.config[b].params).done(function(a){c(a)}).fail(function(){console.log("Error loading JSON feed for "+b+".")})},i.getTopAlbums=function(b){j.trigger("jsonloaded");var c=a("<ol></ol>");a.each(b.topalbums.album,function(b,d){var e=l("album-item",b,i.settings.limit),f=d.artist.name+"-"+d.name+", played "+d.playcount+" times",g=a("<li></li>").attr("title",f).attr("class",e).appendTo(c),h=a("<a></a>").attr("href",d.url).attr("target","_blank").appendTo(g);if(i.settings.cover){a("<img></img>").attr("src",d.image[i.config.image_key]["#text"]).attr("class","cover").attr("width",i.settings.size).attr("height",i.settings.size).appendTo(h)}var k=a("<span></span>").attr("class","info").appendTo(h);i.settings.artist&&a('<span class="artist">'+d.artist.name+"</span>").appendTo(k),i.settings.album&&a('<span class="album">'+d.name+"</span>").appendTo(k),i.settings.plays&&a('<span class="plays">'+d.playcount+"<span> Plays</span></span>").appendTo(k),j.trigger("attachelement"),c.appendTo(j),j.trigger("elementattached")})},i.getRecentTracks=function(b){j.trigger("jsonloaded");var c=b.recenttracks.track[0]["@attr"];if(!i.settings.playing&&c)b.recenttracks.track.shift();else{var d=c?"listening":null;j.addClass(d)}var e=a("<ol></ol>");a.each(b.recenttracks.track,function(b,d){var f=d.date?", played "+m(d.date):"",g=l("track-item",b,c?Number(i.settings.limit)+1:i.settings.limit),h=d.artist["#text"]+"-"+d.album["#text"]+"-"+d.name+f,k=d["@attr"]?"playing":null,n=a("<li></li>").attr("title",h).attr("class",g).addClass(k).appendTo(e),o=a("<a></a>").attr("href",d.url).attr("target","_blank").appendTo(n);if(i.settings.cover){a("<img></img>").attr("src",d.image[i.config.image_key]["#text"]).attr("class","cover").attr("width",i.settings.size).attr("height",i.settings.size).appendTo(o)}var p=a("<span></span>").attr("class","info").appendTo(o);i.settings.artist&&a('<span class="artist">'+d.artist["#text"]+"</span>").appendTo(p),i.settings.album&&a('<span class="album">'+d.album["#text"]+"</span>").appendTo(p),i.settings.artist&&a('<span class="track">'+d.name+"</span>").appendTo(p),i.settings.date&&f&&a('<span class="date">'+f+"</span>").appendTo(p),j.trigger("attachelement"),e.appendTo(j),j.trigger("elementattached")})},i.getNowPlaying=function(b){j.trigger("jsonloaded");var c=b.recenttracks.track[0]?b.recenttracks.track[0]:b.recenttracks.track,d=c["@attr"]?c["@attr"]:null,e=d?"listening":null;j.addClass(e);var f=a("<div></div>"),g=a("<a></a>").attr("href",c.url).attr("target","_blank").appendTo(f);if(i.settings.cover){a("<img></img>").attr("src",c.image[i.config.image_key]["#text"]).attr("class","cover").attr("width",i.settings.size).attr("height",i.settings.size).appendTo(g)}var h=a("<span></span>").attr("class","info").appendTo(g);i.settings.artist&&a('<span class="artist">'+c.artist["#text"]+"</span>").appendTo(h),i.settings.album&&a('<span class="album">'+c.album["#text"]+"</span>").appendTo(h),i.settings.artist&&a('<span class="track">'+c.name+"</span>").appendTo(h),(i.settings.recent||d)&&(j.trigger("attachelement"),f.appendTo(j),j.trigger("elementattached"))};var k=function(a){var b=34>=a?0:64>=a?1:126>=a?2:3;return b},l=function(a,b,c){var d=0===b?"first":"",e=b===c-1?"last":"",f=[a,d,e],g=f.clean("").join(" ").trim();return g},m=function(a){var b=60,c=60*b,d=new Date,e=d.getTime(),f=String(e).substr(0,a.uts.length),g=f-a.uts,h=60>g/b?Math.round(g/b)+" minute":24>g/c?Math.round(g/c)+" hour":null,i=g>1?"s":"",j=h?h+i+" ago":a["#text"];return j};i.init()},a.fn.myLastFM=function(b,c,d,e){return this.each(function(){if(!a(this).data("myLastFM")){var f=new a.myLastFM(this,b,c,d,e);a(this).data("pluginName",f)}}),this},String.prototype.cleanup=function(){return this.toLowerCase().replace(/[^a-zA-Z0-9]+/g,"-")},Array.prototype.clean=function(a){for(var b=0;b<this.length;b++)this[b]===a&&(this.splice(b,1),b--);return this}}(jQuery,window,document);