/*!
 * lastfmfeeds v0.1.0 - Last FM Feed JS
 * https://github.com/chriskinch/lastfm_widget
 */
!function(a,b){"object"==typeof exports?module.exports=b():"function"==typeof define&&define.amd?define("lastfmfeeds",[],b):a.lastfmfeeds=b()}(this,function(){function a(){}function b(a,b){this.element=a,this.settings=b,this.status=null}function c(a,b){this.element=a,this.settings=b,this.status=null}function d(a,b,c){var d=0===b?"first":"",e=b===c-1?"last":"",f=[a,d,e],g=f.clean("").join(" ").trim();return g}function e(a){var b=60,c=60*b,d=new Date,e=d.getTime(),f=String(e).substr(0,a.uts.length),g=f-a.uts,h=60>g/b?Math.round(g/b)+" minute":24>g/c?Math.round(g/c)+" hour":null,i=g>1?"s":"",j=h?h+i+" ago":a["#text"];return j}function f(a,b){for(var c in a)if(a.hasOwnProperty(c)&&(cont=b(c,a[c]),cont===!1))break}function g(){for(var a=1;a<arguments.length;a++)for(var b in arguments[a])arguments[a].hasOwnProperty(b)&&(arguments[0][b]=arguments[a][b]);return arguments[0]}function h(a){var b="";for(var c in a)""!==b&&(b+="&"),b+=c+"="+a[c];return b}var i={};return a.prototype={init:function(a,c,d,e,f){var h={};h.selector=a,h.element=document.querySelectorAll(a)[0];var j={limit:10,size:64,period:"1month",cover:!0,album:!0,artist:!0,plays:!0,date:!0,playing:!0};h.settings=g({},j,f),h.config={url:"http://ws.audioscrobbler.com/2.0/?",params:{method:e,format:"json",user:c,api_key:d,limit:h.settings.limit,size:h.settings.size,period:h.settings.period,callback:""}};var k=new CustomEvent("lastfmfeeds:init");window.dispatchEvent(k);var l=new b(h.element,h.settings);l.loadFeed(h.config.url,h.config.params),i[a]=h},destroy:function(a){void 0===a&&(a=Object.keys(i)),f(a,function(a,b){var c=i[b],d=document.querySelectorAll(b);if(void 0!==c){var e=new CustomEvent("lastfmfeeds:destroy");window.dispatchEvent(e),d[0].innerHTML=null,delete i[b]}})},refresh:function(a){var c=this;void 0===a&&(a=Object.keys(i)),f(a,function(a,d){var e=i[d],f=document.querySelectorAll(d);if(void 0!==e){var g=new CustomEvent("lastfmfeeds:refresh");window.dispatchEvent(g);var h=new b(f,e.settings);h.loadFeed(e.config.url,e.config.params),c.destroy([d]),i[d]=e}})},update:function(a,b){var c=i[a],d=c.settings;c.settings=g({},d,b);var e=new CustomEvent("lastfmfeeds:update");window.dispatchEvent(e),this.refresh([a])},feeds:function(){return i}},b.prototype={loadFeed:function(a,b){var d=this,e=new CustomEvent("lastfmfeeds:getjson");window.dispatchEvent(e);try{var f=new XMLHttpRequest,g=h(b);f.onreadystatechange=function(){if(4==f.readyState){var a=new c(d.element,d.settings);a.setup(JSON.parse(f.response))}},f.open("GET",a+g,!0),f.send(null)}catch(i){console.log("Last.fm Feeds: Error loading JSON feed."),console.log(i)}}},c.prototype={setup:function(a){var b=Object.keys(a)[0],c=null;switch(b){case"topalbums":c=a[b].album;break;case"recenttracks":c=a[b].track;break;default:console.log("Last.fm Feeds: Unrecognized feed.")}this.render(b,c)},render:function(a,b){var c,g,h,i,j,k,l=this,m=null,n=document.createDocumentFragment(),o=document.createElement("ol");n.appendChild(o),f(b,function(n,p){var q=[];switch(a){case"topalbums":c=d("item",n,l.settings.limit),h=p.artist.name+"-"+p.name+", played "+p.playcount+" times",q.push(l.buildDOMElement("span",{className:"artist",innerHTML:p.artist.name},l.settings.artist)),q.push(l.buildDOMElement("span",{className:"album",innerHTML:p.name},l.settings.album)),q.push(l.buildDOMElement("span",{className:"plays",innerHTML:p.playcount},l.settings.plays));break;case"recenttracks":k=b[0]["@attr"],!l.settings.playing&&k&&b.shift(),k&&(l.element.className="listening"),g=p.date?", played "+e(p.date):"",c=d("item",n,k?Number(l.settings.limit)+1:l.settings.limit),h=p.artist["#text"]+"-"+p.album["#text"]+"-"+p.name+g,m=p["@attr"]?"playing":null,q.push(l.buildDOMElement("span",{className:"artist",innerHTML:p.artist["#text"]},l.settings.artist)),q.push(l.buildDOMElement("span",{className:"artist",innerHTML:p.album["#text"]},l.settings.album)),q.push(l.buildDOMElement("span",{className:"track",innerHTML:p.name},l.settings.track)),q.push(l.buildDOMElement("span",{className:"date",innerHTML:g},l.settings.date));break;default:console.log("Last.fm Feeds: Unrecognized type.")}i=l.buildDOMElement("li",{title:h,className:c}),o.appendChild(i),link=l.buildDOMElement("a",{href:p.url,target:"_blank"}),i.appendChild(link);var r=p.image[l.getImageKey(l.settings.size)]["#text"],s=l.buildDOMElement("img",{src:r,className:"cover",width:l.settings.size,height:l.settings.size},l.settings.cover);link.appendChild(s),j=l.buildDOMElement("span",{className:"info"}),link.appendChild(j),f(q,function(a,b){j.appendChild(b)})});var p=new CustomEvent("lastfmfeeds:attachelement");window.dispatchEvent(p),this.element.appendChild(n)},buildDOMElement:function(a,b,c){if(c!==!1){var d=document.createElement(a);return f(b,function(a,b){d[a]=b}),d}},getImageKey:function(a){var b=34>=a?0:64>=a?1:126>=a?2:3;return b}},String.prototype.cleanup=function(){return this.toLowerCase().replace(/[^a-zA-Z0-9]+/g,"-")},Array.prototype.clean=function(a){for(var b=0;b<this.length;b++)this[b]===a&&(this.splice(b,1),b--);return this},"function"!=typeof window.CustomEvent&&!function(){function a(a,b){b=b||{bubbles:!1,cancelable:!1,detail:void 0};var c=document.createEvent("CustomEvent");return c.initCustomEvent(a,b.bubbles,b.cancelable,b.detail),c}window.CustomEvent=a,a.prototype=window.CustomEvent.prototype}(),new a});