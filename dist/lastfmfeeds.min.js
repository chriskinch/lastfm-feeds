/*!
 * lastfmfeeds v0.1.0 - Last FM Feed JS
 * https://github.com/chriskinch/lastfm_widget
 */
!function(a,b){"object"==typeof exports?module.exports=b(require("jquery")):"function"==typeof define&&define.amd?define("lastfmfeeds",["jquery"],b):a.lastfmfeeds=b(a.jquery)}(this,function(){function a(){if(!jQuery)throw new Error("jQuery is not present, please load it before calling any methods")}function b(a,b){this.element=a,this.settings=b,this.status=null}function c(a,b){this.element=a,this.settings=b,this.status=null}var d={};a.prototype={init:function(a,c,e,f,g){var h={};h.selector=a,h.element=$(a);var i={limit:10,size:64,period:"1month",cover:!0,album:!0,artist:!0,plays:!0,date:!0,playing:!0};h.settings=$.extend({},i,g),h.config={url:"http://ws.audioscrobbler.com/2.0/?",params:{method:f,format:"json",user:c,api_key:e,limit:h.settings.limit,size:h.settings.size,period:h.settings.period,callback:""}},h.element.trigger("lastfmfeeds:init");var j=new b(h.element,h.settings);j.loadFeed(h.config.url,h.config.params),d[a]=h},destroy:function(a){void 0===a&&(a=Object.keys(d)),$.each(a,function(a,b){var c=d[b],e=$(b);void 0!==c&&(e.trigger("lastfmfeeds:destroy"),e.empty(),delete d[b])})},refresh:function(a){var c=this;void 0===a&&(a=Object.keys(d)),$.each(a,function(a,e){var f=d[e],g=$(e);if(void 0!==f){g.trigger("lastfmfeeds:refresh");var h=new b(g,f.settings);h.loadFeed(f.config.url,f.config.params),c.destroy([e]),d[e]=f}})},update:function(a,b){var c=d[a],e=c.settings;c.settings=$.extend({},e,b),element.trigger("lastfmfeeds:update"),this.refresh([a])},feeds:function(){return d}},b.prototype={loadFeed:function(a,b){var d=this;this.element.trigger("lastfmfeeds:getjson"),$.getJSON(a,b).done(function(a){d.element.trigger("lastfmfeeds:jsonloaded");var b=new c(d.element,d.settings);b.setup(a)}).fail(function(){console.log("Last.fm Feeds: Error loading JSON feed.")})}},c.prototype={setup:function(a){var b=Object.keys(a)[0],c=null;switch(b){case"topalbums":c=a.topalbums.album;break;case"recenttracks":c=a.recenttracks.track;break;default:console.log("Last.fm Feeds: Unrecognized feed.")}this.render(b,c)},render:function(a,b){var c,d,g,h=this,i=null;if("recenttracks"==a){var j=b[0]["@attr"];if(!h.settings.playing&&j)b.shift();else{var k=j?"listening":null;h.element.addClass(k)}}var l=$("<ol></ol>");$.each(b,function(b,k){switch(a){case"topalbums":c=e("item",b,h.settings.limit),g=k.artist.name+"-"+k.name+", played "+k.playcount+" times";break;case"recenttracks":d=k.date?", played "+f(k.date):"",c=e("track-item",b,j?Number(h.settings.limit)+1:h.settings.limit),g=k.artist["#text"]+"-"+k.album["#text"]+"-"+k.name+d,i=k["@attr"]?"playing":null;break;default:console.log("Last.fm Feeds: Unrecognized type.")}var m=$("<li></li>").attr("title",g).attr("class",c).appendTo(l),n=$("<a></a>").attr("href",k.url).attr("target","_blank").appendTo(m);if(h.settings.cover){$("<img></img>").attr("src",k.image[h.getImageKey(h.settings.size)]["#text"]).attr("class","cover").attr("width",h.settings.size).attr("height",h.settings.size).appendTo(n)}var o=$("<span></span>").attr("class","info").appendTo(n);switch(a){case"topalbums":h.settings.artist&&$('<span class="artist">'+k.artist.name+"</span>").appendTo(o),h.settings.album&&$('<span class="album">'+k.name+"</span>").appendTo(o),h.settings.plays&&$('<span class="plays">'+k.playcount+"<span> Plays</span></span>").appendTo(o);break;case"recenttracks":h.settings.artist&&$('<span class="artist">'+k.artist["#text"]+"</span>").appendTo(o),h.settings.album&&$('<span class="album">'+k.album["#text"]+"</span>").appendTo(o),h.settings.artist&&$('<span class="track">'+k.name+"</span>").appendTo(o),h.settings.date&&d&&$('<span class="date">'+d+"</span>").appendTo(o);break;default:console.log("Last.fm Feeds: Unrecognized type.")}}),h.element.trigger("lastfmfeeds:attachelement"),l.appendTo(h.element),h.element.trigger("lastfmfeeds:elementattached")},getImageKey:function(a){var b=34>=a?0:64>=a?1:126>=a?2:3;return b}},String.prototype.cleanup=function(){return this.toLowerCase().replace(/[^a-zA-Z0-9]+/g,"-")},Array.prototype.clean=function(a){for(var b=0;b<this.length;b++)this[b]===a&&(this.splice(b,1),b--);return this};var e=function(a,b,c){var d=0===b?"first":"",e=b===c-1?"last":"",f=[a,d,e],g=f.clean("").join(" ").trim();return g},f=function(a){var b=60,c=60*b,d=new Date,e=d.getTime(),f=String(e).substr(0,a.uts.length),g=f-a.uts,h=60>g/b?Math.round(g/b)+" minute":24>g/c?Math.round(g/c)+" hour":null,i=g>1?"s":"",j=h?h+i+" ago":a["#text"];return j};return"function"!=typeof window.CustomEvent&&!function(){function a(a,b){b=b||{bubbles:!1,cancelable:!1,detail:void 0};var c=document.createEvent("CustomEvent");return c.initCustomEvent(a,b.bubbles,b.cancelable,b.detail),c}window.CustomEvent=a,a.prototype=window.CustomEvent.prototype}(),new a});